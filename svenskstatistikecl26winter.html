<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>ECL 26 Winter ‚Äì Svenska ligor</title>
  <link rel="icon" type="image/png" href="favicon.png?v=1">
<link rel="apple-touch-icon" href="favicon.png?v=1">
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg-dark: #04123a;
      --bg-darker: #020718;
      --accent-orange: #f9a64a;
      --accent-yellow: #f7d35f;
      --accent-blue: #102a68;
      --text-main: #f5f6ff;
      --text-muted: #c5c8de;
      --card-bg: #07132f;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Inter, system-ui, Arial, sans-serif;
      background:
        radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.05), transparent 60%),
        radial-gradient(circle at 100% 0, rgba(255, 255, 255, 0.04), transparent 65%),
        linear-gradient(180deg, #020719, #020414 60%, #000);
      color: var(--text-main);
      min-height: 100vh;
    }

    .page-wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 10px 40px;
    }

    /* -------------------------------------
       TABS
    --------------------------------------*/
    .ecl-tabs {
      display: inline-flex;
      gap: 8px;
      margin: 8px 0 16px;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.4);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.8);
    }
    .ecl-tab {
      border: none;
      padding: 7px 16px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.06);
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .08em;
      transition: 0.18s;
    }
    .ecl-tab.active {
      background: linear-gradient(135deg, var(--accent-orange), var(--accent-yellow));
      color: #141320;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.4), 0 10px 26px rgba(0,0,0,0.8);
      transform: translateY(-1px);
    }

    /* -------------------------------------
       TITEL
    --------------------------------------*/
    .page-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0 18px;
      color: var(--text-main);
      text-shadow: 0 3px 18px rgba(0,0,0,0.9);
    }
    .page-title-icon { font-size: 26px; }
    .page-title-text {
      font-size: 20px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .page-sub {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .16em;
    }

    /* -------------------------------------
       HEADER / S√ñK
    --------------------------------------*/
    .header-box {
      display: flex; flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    .header-box h2 {
      font-size: 18px;
      font-weight: 800;
      text-transform: uppercase;
      color: var(--text-main);
      margin: 0;
    }
    .header-box input {
      padding: 8px 12px;
      background: #07132f;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      outline: none;
      min-width: 230px;
    }

    /* -------------------------------------
       TOP 3 KORT
    --------------------------------------*/
    .top3-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px;
      margin-bottom: 18px;
    }

    .player-card {
      position: relative;
      background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent 30%),
                  linear-gradient(180deg, #0a1740, #020716);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
      overflow: hidden;
    }

    .team-logo-card {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 46px;
      height: 46px;
      object-fit: contain;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.75));
      pointer-events: none;
      opacity: 0.95;
    }

    .player-ribbon {
      position: absolute;
      top: 0;
      left: 0;
      background: rgba(0,0,0,0.5);
      padding: 4px 10px;
      font-size: 10px;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: .16em;
    }
    .player-rank-badge {
      position: absolute;
      bottom: 6px;
      left: 10px;
      font-size: 40px;
      font-weight: 900;
      color: rgba(255,255,255,0.05);
    }

    .player-top-row {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .player-img-wrap {
      flex: 0 0 90px;
      height: 120px;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.8);
      background: #000;
    }
    .player-img {
      width: 100%; height: 100%;
      object-fit: cover;
      display: block;
    }

    .player-name {
      font-size: 16px;
      font-weight: 800;
      text-transform: uppercase;
    }
    .player-team {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .player-points {
      margin-top: 4px;
      font-size: 13px;
    }
    .player-ga {
      font-size: 12px;
      color: #ddd;
    }

    .stat-bars { margin-top: 8px; }
    .bar-row { margin-bottom: 3px; font-size: 11px; }
    .bar-label { display: flex; justify-content: space-between; }
    .bar-track {
      background: rgba(255,255,255,0.1);
      height: 6px;
      border-radius: 999px;
    }
    .bar-fill {
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(90deg, #f7d35f, #f9a64a);
    }

    /* -------------------------------------
       TABELL
    --------------------------------------*/
    .table-shell {
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
      background: #030a1d;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
    }

    .table-header-strip {
      background: linear-gradient(90deg, #f6983f, #f3c34a);
      color: #111;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .16em;
    }

    .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }

    .table-container table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 700px;
    }
    thead { background: #091540; }
    thead th {
      padding: 8px 10px;
      color: #f7d35f;
      text-transform: uppercase;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }
    tbody td {
      padding: 8px 10px;
      border-bottom: 1px solid #0d1430;
      text-align: center;
    }
    tbody tr:nth-child(even) { background: rgba(255,255,255,0.03); }
    tbody tr:hover { background: rgba(255, 200, 100, 0.12); }

    thead th:nth-child(1),
    thead th:nth-child(2),
    thead th:nth-child(3),
    tbody td:nth-child(1),
    tbody td:nth-child(2),
    tbody td:nth-child(3) { text-align: left; }

    .lastUpdated {
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
      margin-top: 5px;
    }

    @media (max-width: 768px) {
      .ecl-tabs { gap: 6px; padding: 4px 6px; }
      .ecl-tab { padding: 6px 10px; font-size: 11px; letter-spacing: .05em; }
      .team-logo-card { width: 32px; height: 32px; top: 8px; right: 8px; }
    }

    .team-cell {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .team-logo {
      width: 22px;
      height: 22px;
      object-fit: contain;
      flex-shrink: 0;
    }
#sectionDesc {
  font-size: 11px;
  line-height: 1.45;
  color: rgba(245, 246, 255, 0.75);
  margin-top: 4px;
  max-width: 900px;
}
@media (max-width: 768px) {
  #sectionDesc {
    font-size: 10px;
    line-height: 1.4;
  }
}

  </style>
</head>
<body>
<div class="page-wrap">

  <!-- League tabs -->
  <div class="ecl-tabs">
    <button class="ecl-tab active" data-league="skaters">Spelare</button>
    <button class="ecl-tab" data-league="defenders">Backar</button>
    <button class="ecl-tab" data-league="goalies">M√•lvakter</button>
  </div>

  <!-- Division tabs -->
  <div class="ecl-tabs">
    <button class="ecl-tab active" data-division="elite">Elite</button>
    <button class="ecl-tab" data-division="pro">Pro</button>
    <button class="ecl-tab" data-division="lite">Lite</button>
    <button class="ecl-tab" data-division="core">Core</button>
    <button class="ecl-tab" data-division="neo">Neo</button>
  </div>

  <div class="page-title">
    <div class="page-title-icon" id="titleIcon">üèÜ</div>
    <div>
      <div class="page-title-text" id="titleText">ECL 26 Winter ‚Äì Svenska po√§ngligor</div>
      <div class="page-sub" id="titleSub"></div>
    </div>
  </div>

  <div class="header-box">
    <h2 id="sectionTitle">Elite Po√§ngliga</h2>
<div id="sectionDesc" class="page-sub"></div>
    <input id="searchBox" placeholder="S√∂k spelare/m√•lvakt eller lag‚Ä¶" />
  </div>

  <div id="top3" class="top3-container"></div>

  <div class="table-shell">
    <div class="table-header-strip" id="tableStrip">Topplista</div>
    <div id="tableHost" class="table-container"></div>
  </div>
  <p id="updated" class="lastUpdated"></p>

</div>

<script>
(function(){

  const TABLE_SHEET_ID = "1toag5J7vMW0CEmtsrqByPJMJn6e-U5hOzZaKWoXnpxY";

  const CARD_CSV =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSZCNO-QbbfniaDOODJpcE_B8ab6RHunhkSRGuEjYeVlM2TVq6okNMG8JPHHZyWf50RsJFflI6bbAnB/pub?gid=2047009971&single=true&output=csv";

  const DEFAULT_IMG =
    "https://drive.google.com/thumbnail?id=1VAa79pJ-QbyeliY60autf914z6SBwmhp&sz=w1000";

  function sheetUrl(sheetName){
    return `https://docs.google.com/spreadsheets/d/${TABLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  }

  const DATA_SHEETS = {
    skaters: sheetUrl("Utespelare"),
    defenders: sheetUrl("Backar"),
    goalies: sheetUrl("M√•lvakter")
  };

  const LOGO_SHEET = sheetUrl("Loggor");

  let activeLeague = "skaters";
  let activeDiv = "elite";

  let currentSort = { idx: null, key: null };

  const divLabels = {
    elite: "Elite",
    pro: "Pro",
    lite: "Lite",
    core: "Core",
    neo: "Neo"
  };

  const sortTitles = {
    p: "Po√§ngliga",
    m: "Skytteligan",
    a: "Assistligan",
    u: "Busligan",
    ma: "Flest spelade matcher",
    dim: "Defensiv Impact-ligan",
    svp: "R√§ddningsligan",
    gaa: "GAA-ligan",
    so: "Nolligan"
  };

  function parseCSV(txt){
    const out=[]; let row=[], cur="", q=false;
    for(let i=0;i<txt.length;i++){
      const c=txt[i], n=txt[i+1];
      if(c=='"'&&n=='"'){cur+='"';i++;continue;}
      if(c=='"'){q=!q;continue;}
      if(c==","&&!q){row.push(cur);cur="";continue;}
      if((c=="\n"||c=="\r")&&!q){
        if(cur||row.length){row.push(cur);out.push(row);}
        row=[];cur="";continue;
      }
      cur+=c;
    }
    if(cur||row.length){row.push(cur);out.push(row);}
    return out;
  }

  const normalize = s =>
    String(s||"").normalize("NFKD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^\w\s]/g,"").toLowerCase().trim();

  const toNum = x => parseFloat(String(x||"").replace(",",".").replace("%","")) || 0;

  const parseSVP = v => {
    let n=toNum(v);
    return n>1?n/100:n;
  };

  const formatSVP = v => (parseSVP(v)*100).toFixed(1)+"%";
  const formatGAA = v => toNum(v).toFixed(2);

  let cardMap=null, logoMap=null;

  function loadCardImages(){
    if(cardMap) return Promise.resolve(cardMap);
    return fetch(CARD_CSV).then(r=>r.text()).then(t=>{
      const m={}; parseCSV(t).slice(1).forEach(r=>{
        m[normalize(r[0])] = r[1]
          ? `https://drive.google.com/thumbnail?id=${r[1]}&sz=w1000`
          : DEFAULT_IMG;
      });
      cardMap=m; return m;
    });
  }

  function loadTeamLogos(){
    if(logoMap) return Promise.resolve(logoMap);
    return fetch(LOGO_SHEET).then(r=>r.text()).then(t=>{
      const m={}; parseCSV(t).slice(1).forEach(r=>{
        if(r[0]&&r[1]) m[normalize(r[0])] = r[1];
      });
      logoMap=m; return m;
    });
  }

  function renderTop3(players, host){
    host.innerHTML = players.slice(0,3).map((p,i)=>`
      <div class="player-card">
        <div class="player-rank-badge">${i+1}</div>
        <div class="player-name">${p.name}</div>
        <div class="player-team">${p.team}</div>
      </div>
    `).join("");
  }

  // ‚úÖ Enda √§ndringen: m√•lvakter default-sort p√• b√§sta SV% (h√∂gst f√∂rst)
  function findGoalieSVPColIndex(header){
    const candidates = ["SV%", "SVP", "R√§ddningsprocent", "R√§ddnings%", "SV"];
    const norms = header.map(h => normalize(h));
    for(const c of candidates){
      const idx = norms.indexOf(normalize(c));
      if(idx !== -1) return idx + 1; // +1 eftersom th-index 0 √§r "#"
    }
    return null;
  }

  function renderTable(header, rows, host, search, objs, top3){
    let data = rows.map((r,i)=>({r,i}));

    host.innerHTML = `
      <table>
        <thead><tr>${["#",...header].map((h,i)=>`<th data-i="${i}">${h}</th>`).join("")}</tr></thead>
        <tbody></tbody>
      </table>
    `;

    const tbody = host.querySelector("tbody");
    const ths = host.querySelectorAll("th");
    let sortState={i:null,asc:false};

    // ‚úÖ Default-sort endast f√∂r m√•lvakter: b√§sta SV% f√∂rst
    if(activeLeague === "goalies"){
      const svI = findGoalieSVPColIndex(header);
      if(svI){
        sortState.i = svI;
        sortState.asc = false; // false = desc (h√∂gst f√∂rst)
        data.sort((a,b)=>{
          const av=toNum(a.r[svI-1]), bv=toNum(b.r[svI-1]);
          return (av-bv)*(sortState.asc?1:-1);
        });
      }
    }

    function redraw(){
      tbody.innerHTML = data.map((d,i)=>`
        <tr><td>${i+1}</td>${d.r.map(c=>`<td>${c}</td>`).join("")}</tr>
      `).join("");

      let visible = data.map(d=>{
        const o = objs[d.i];
        if(sortState.i){
          o.__v = toNum(d.r[sortState.i-1]);
        }
        return o;
      });

      // üîí KRITISK FIX ‚Äì Top-3 f√∂ljer EXAKT tabellens sort
      if(sortState.i){
        const dir = sortState.asc ? 1 : -1;
        visible.sort((a,b)=> (a.__v-b.__v)*dir);
      }

      renderTop3(visible, top3);
    }

    ths.forEach(th=>{
      th.onclick=()=>{
        const i=+th.dataset.i;
        if(!i) return;
        sortState.asc = sortState.i===i ? !sortState.asc : false;
        sortState.i=i;

        data.sort((a,b)=>{
          const av=toNum(a.r[i-1]), bv=toNum(b.r[i-1]);
          return (av-bv)*(sortState.asc?1:-1);
        });

        redraw();
      };
    });

    redraw();
  }

  function load(){
    Promise.all([loadCardImages(),loadTeamLogos()]).then(()=>{
      fetch(DATA_SHEETS[activeLeague]).then(r=>r.text()).then(t=>{
        const rows=parseCSV(t); const h=rows.shift();
        renderTable(h,rows,tableHost,searchBox,[],top3);
      });
    });
  }

  const tableHost=document.getElementById("tableHost");
  const top3=document.getElementById("top3");
  const searchBox=document.getElementById("searchBox");

  load();

})();
</script>

</body>
</html>
