<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>ECL 26 Winter ‚Äì Svenska ligor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg-dark: #04123a;
      --bg-darker: #020718;
      --accent-orange: #f9a64a;
      --accent-yellow: #f7d35f;
      --accent-blue: #102a68;
      --text-main: #f5f6ff;
      --text-muted: #c5c8de;
      --card-bg: #07132f;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Inter, system-ui, Arial, sans-serif;
      background:
        radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.05), transparent 60%),
        radial-gradient(circle at 100% 0, rgba(255, 255, 255, 0.04), transparent 65%),
        linear-gradient(180deg, #020719, #020414 60%, #000);
      color: var(--text-main);
      min-height: 100vh;
    }

    .page-wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 10px 40px;
    }

    /* -------------------------------------
       TABS
    --------------------------------------*/
    .ecl-tabs {
      display: inline-flex;
      gap: 8px;
      margin: 8px 0 16px;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.4);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.8);
      flex-wrap: wrap;
    }
    .ecl-tab {
      border: none;
      padding: 7px 16px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.06);
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .08em;
      transition: 0.18s;
      white-space: nowrap;
    }
    .ecl-tab.active {
      background: linear-gradient(135deg, var(--accent-orange), var(--accent-yellow));
      color: #141320;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.4), 0 10px 26px rgba(0,0,0,0.8);
      transform: translateY(-1px);
    }

    /* -------------------------------------
       TITEL
    --------------------------------------*/
    .page-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0 18px;
      color: var(--text-main);
      text-shadow: 0 3px 18px rgba(0,0,0,0.9);
    }
    .page-title-icon { font-size: 26px; }
    .page-title-text {
      font-size: 20px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .page-sub {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .16em;
    }

    /* -------------------------------------
       HEADER / S√ñK
    --------------------------------------*/
    .header-box {
      display: flex; flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    .header-box h2 {
      font-size: 18px;
      font-weight: 800;
      text-transform: uppercase;
      color: var(--text-main);
      margin: 0;
    }
    .header-box input {
      padding: 8px 12px;
      background: #07132f;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      outline: none;
      min-width: 230px;
    }

    /* -------------------------------------
       TOP 3 KORT
    --------------------------------------*/
    .top3-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px;
      margin-bottom: 18px;
    }

    .player-card{
      position: relative;
      border-radius: 18px;
      padding: 12px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
      background: linear-gradient(180deg, #0a1740, #020716);
    }

    .player-card::after{
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      border-radius: 18px;
      overflow: hidden;
      background: linear-gradient(
        135deg,
        rgba(255,255,255,0.08) 0%,
        rgba(255,255,255,0.04) 25%,
        transparent 45%
      );
      -webkit-mask-image: radial-gradient(white, black);
              mask-image: radial-gradient(white, black);
      z-index: 1;
    }

    .player-card > *{
      position: relative;
      z-index: 2;
    }

    .team-logo-card {
      width: 46px;
      height: 46px;
      object-fit: contain;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.75));
      pointer-events: none;
      opacity: 0.95;
    }

    .player-ribbon{
      position: absolute;
      top: 0;
      left: 0;
      background: rgba(0,0,0,0.5);
      padding: 4px 10px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .16em;
      border-top-left-radius: 18px;
      border-bottom-right-radius: 12px;
      overflow: hidden;
    }

    .player-top-row {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .player-img-wrap{
      flex: 0 0 90px;
      height: 120px;
      overflow: hidden;
      background: #000;
      border: 2px solid rgba(255,255,255,0.8);
      border-radius: 12px;
      clip-path: inset(0 round 12px);
      box-shadow: 0 2px 10px rgba(0,0,0,0.35);
    }
    .player-img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 12px;
    }

    .player-name {
      font-size: 16px;
      font-weight: 800;
      text-transform: uppercase;
    }
    .player-team {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .player-points {
      margin-top: 4px;
      font-size: 13px;
    }
    .player-ga {
      font-size: 12px;
      color: #ddd;
    }

    .stat-bars { margin-top: 8px; }
    .bar-row { margin-bottom: 3px; font-size: 11px; }
    .bar-label { display: flex; justify-content: space-between; }
    .bar-track {
      background: rgba(255,255,255,0.1);
      height: 6px;
      border-radius: 999px;
    }
    .bar-fill {
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(90deg, #f7d35f, #f9a64a);
    }

    /* -------------------------------------
       TABELL
    --------------------------------------*/
    .table-shell {
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
      background: #030a1d;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
    }

    .table-header-strip {
      background: linear-gradient(90deg, #f6983f, #f3c34a);
      color: #111;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .16em;
    }

    .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }

    .table-container table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 700px;
    }
    thead { background: #091540; }
    thead th {
      padding: 8px 10px;
      color: #f7d35f;
      text-transform: uppercase;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }
    tbody td {
      padding: 8px 10px;
      border-bottom: 1px solid #0d1430;
      text-align: center;
    }
    tbody tr:nth-child(even) { background: rgba(255,255,255,0.03); }
    tbody tr:hover { background: rgba(255, 200, 100, 0.12); }

    thead th:nth-child(1),
    thead th:nth-child(2),
    thead th:nth-child(3),
    tbody td:nth-child(1),
    tbody td:nth-child(2),
    tbody td:nth-child(3) { text-align: left; }

    .lastUpdated {
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
      margin-top: 5px;
    }

    @media (max-width: 768px) {
      .ecl-tabs { gap: 6px; padding: 4px 6px; }
      .ecl-tab { padding: 6px 10px; font-size: 11px; letter-spacing: .05em; }
      .team-logo-card { width: 32px; height: 32px; }
    }

    #sectionDesc {
      font-size: 11px;
      line-height: 1.45;
      color: rgba(245, 246, 255, 0.75);
      margin-top: 4px;
      max-width: 900px;
    }
    @media (max-width: 768px) {
      #sectionDesc { font-size: 10px; line-height: 1.4; }
    }

    .team-logo-wrap {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .team-medal {
      font-size: 18px;
      line-height: 1;
      opacity: 0.9;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.6));
    }
  </style>
</head>

<body>
<div class="page-wrap">

  <!-- ‚úÖ NYTT: Grundserie / Slutspel -->
  <div class="ecl-tabs" aria-label="Spelform">
    <button class="ecl-tab active" data-stage="regular">Grundserie</button>
    <button class="ecl-tab" data-stage="playoffs">Slutspel</button>
  </div>

  <!-- League tabs -->
  <div class="ecl-tabs" aria-label="Roll">
    <button class="ecl-tab active" data-league="skaters">Spelare</button>
    <button class="ecl-tab" data-league="defenders">Backar</button>
    <button class="ecl-tab" data-league="goalies">M√•lvakter</button>
  </div>

  <!-- Division tabs -->
  <div class="ecl-tabs" aria-label="Division">
    <button class="ecl-tab active" data-division="elite">Elite</button>
    <button class="ecl-tab" data-division="pro">Pro</button>
    <button class="ecl-tab" data-division="lite">Lite</button>
    <button class="ecl-tab" data-division="core">Core</button>
    <button class="ecl-tab" data-division="neo">Neo</button>
  </div>

  <div class="page-title">
    <div class="page-title-icon" id="titleIcon">üèÜ</div>
    <div>
      <div class="page-title-text" id="titleText">ECL 26 Winter ‚Äì Svenska po√§ngligor</div>
      <div class="page-sub" id="titleSub"></div>
    </div>
  </div>

  <div class="header-box">
    <div>
      <h2 id="sectionTitle">Elite Po√§ngliga</h2>
      <div id="sectionDesc" class="page-sub"></div>
    </div>
    <input id="searchBox" placeholder="S√∂k spelare/m√•lvakt eller lag‚Ä¶" />
  </div>

  <div id="top3" class="top3-container"></div>

  <div class="table-shell">
    <div class="table-header-strip" id="tableStrip">Topplista</div>
    <div id="tableHost" class="table-container"></div>
  </div>
  <p id="updated" class="lastUpdated"></p>

</div>

<script>
(function(){

  const TABLE_SHEET_ID = "1toag5J7vMW0CEmtsrqByPJMJn6e-U5hOzZaKWoXnpxY";

  const CARD_CSV =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSZCNO-QbbfniaDOODJpcE_B8ab6RHunhkSRGuEjYeVlM2TVq6okNMG8JPHHZyWf50RsJFflI6bbAnB/pub?gid=2047009971&single=true&output=csv";

  const DEFAULT_IMG =
    "https://drive.google.com/thumbnail?id=1VAa79pJ-QbyeliY60autf914z6SBwmhp&sz=w1000";

  function sheetUrl(sheetName){
    return `https://docs.google.com/spreadsheets/d/${TABLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  }

  // ‚úÖ Grundserie (dina vanliga blad)
  const DATA_SHEETS_REGULAR = {
    skaters:   sheetUrl("Utespelare"),
    defenders: sheetUrl("Backar"),
    goalies:   sheetUrl("M√•lvakter")
  };

  // ‚úÖ Slutspel (dina "slut"-blad)
  const DATA_SHEETS_PLAYOFFS = {
    skaters:   sheetUrl("Utespelare slut"),
    defenders: sheetUrl("Backar slut"),
    goalies:   sheetUrl("M√•lvakter slut")
  };

  const LOGO_SHEET = sheetUrl("Loggor");

  let activeStage  = "regular"; // regular | playoffs
  let activeLeague = "skaters"; // skaters | defenders | goalies
  let activeDiv    = "elite";   // elite | pro | lite | core | neo

  // nuvarande sortkolumn
  let currentSort = { idx: null, key: null, label: null };

  const divLabels = {
    elite: "Elite",
    pro: "Pro",
    lite: "Lite",
    core: "Core",
    neo: "Neo"
  };

  const stageLabels = {
    regular: "Grundserie",
    playoffs: "Slutspel"
  };

  const sortTitles = {
    // Utespelare / Backar
    p: "Po√§ngliga",
    m: "M√•lligan",
    a: "Assistligan",
    u: "Busligan",
    ma: "Matchligan",

    // Backar ‚Äì special
    dim: "Defensiv Impact-ligan",

    // M√•lvakter
    "sv%": "B√§sta r√§ddningsprocent",
    svp: "B√§sta r√§ddningsprocent",
    gaa: "GAA-ligan",
    nollor: "Nolligan",
    so: "Nolligan"
  };

  function parseCSV(txt){
    const out = [];
    let row=[], cur="", q=false;

    for(let i=0;i<txt.length;i++){
      const c = txt[i], n = txt[i+1];
      if(c=='"' && n=='"'){ cur+='"'; i++; continue; }
      if(c=='"'){ q=!q; continue; }
      if(c=="," && !q){ row.push(cur); cur=""; continue; }
      if((c=="\n"||c=="\r") && !q){
        if(cur.length||row.length){ row.push(cur); out.push(row); }
        row=[]; cur=""; continue;
      }
      cur+=c;
    }
    if(cur.length||row.length){ row.push(cur); out.push(row); }
    return out.filter(r => r.some(x => String(x).trim() !== ""));
  }

  function normalize(str){
    return String(str||"")
      .normalize("NFKD")
      .replace(/[\u0300-\u036f]/g,"")
      .replace(/[^\w\s]/g,"")
      .replace(/\s+/g," ")
      .trim()
      .toLowerCase();
  }

  function resolveSortKey(colName){
    const k = normalize(colName);

    // M√•lvakter
    if(k === "sv" || k === "svprocent" || k === "raddningsprocent") return "svp";
    if(k === "sv%") return "svp";
    if(k === "gaa") return "gaa";
    if(k === "nollor" || k === "so" || k === "shutouts") return "so";

    // Spelare / Backar
    if(k === "p") return "p";
    if(k === "m") return "m";
    if(k === "a") return "a";
    if(k === "u") return "u";
    if(k === "ma" || k === "matcher") return "ma";
    if(k === "dim") return "dim";

    return k;
  }

  function findDivIndex(header){
    const candidates = ["division","div","liga","league","niv√•","niva","level"];
    const norm = header.map(h => normalize(h));
    for(let i=0;i<norm.length;i++){
      if(candidates.includes(norm[i])) return i;
    }
    return -1;
  }

  function isRowInDivision(row, divValue){
    const v = normalize(row || "");
    const target = normalize(divValue);
    if(!v) return false;
    return v === target;
  }

  function toNum(x){
    const v = String(x||"").replace(",", ".").replace("%","");
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  }

  function parseSVP(raw){
    let n = toNum(raw);
    if(n > 1) n = n / 100;
    return n;
  }

  function formatSVP(raw){
    const n = parseSVP(raw) * 100;
    return n.toFixed(1) + "%";
  }

  function formatGAA(raw){
    const n = toNum(raw);
    if(!n) return String(raw||"-");
    return n.toFixed(2);
  }

  let cardMap=null;
  let cardPromise=null;

  function loadCardImages(){
    if(cardMap) return Promise.resolve(cardMap);
    if(cardPromise) return cardPromise;

    cardPromise = fetch(CARD_CSV)
      .then(r=>r.text())
      .then(csv=>{
        const rows = parseCSV(csv);
        rows.shift();
        const map = {};
        rows.forEach(r=>{
          const name = normalize(r[0]);
          const driveId = (r[1]||"").trim();
          if(!name) return;
          map[name] = driveId ? `https://drive.google.com/thumbnail?id=${driveId}&sz=w1000` : DEFAULT_IMG;
        });
        cardMap = map;
        return map;
      })
      .catch(()=> (cardMap = {}, cardMap));

    return cardPromise;
  }

  let logoMap=null;
  let logoPromise=null;

  function loadTeamLogos(){
    if(logoMap) return Promise.resolve(logoMap);
    if(logoPromise) return logoPromise;

    logoPromise = fetch(LOGO_SHEET)
      .then(r=>r.text())
      .then(csv=>{
        const rows = parseCSV(csv);
        rows.shift();
        const map = {};
        rows.forEach(r=>{
          const team = normalize(r[0]);
          const link = (r[1] || "").trim();
          if(!team || !link) return;
          map[team] = link;
        });
        logoMap = map;
        return map;
      })
      .catch(()=> (logoMap = {}, logoMap));

    return logoPromise;
  }

  function metricTextForPlayer(p){
    const key = currentSort.key;

    if(!key){
      if(activeLeague === "goalies"){
        return {
          main: `${formatSVP(p.svp)} r√§ddningsprocent`,
          sub:  `M ${p.games} ¬∑ GAA ${formatGAA(p.gaa)} ¬∑ Nollor ${p.shutouts}`
        };
      }
      return {
        main: `${p.points} po√§ng`,
        sub:  `GP ${p.games} ¬∑ G ${p.goals} ¬∑ A ${p.assists}`
      };
    }

    const raw = p.__sortRaw ?? "";
    const num = p.__sortNum ?? 0;

    if(activeLeague === "goalies"){
      if(key === "svp" || key === "sv%"){
        return {
          main: `${formatSVP(raw)} r√§ddningsprocent`,
          sub:  `M ${p.games} ¬∑ GAA ${formatGAA(p.gaa)} ¬∑ Nollor ${p.shutouts}`
        };
      }
      if(key === "gaa"){
        return {
          main: `GAA ${formatGAA(raw)}`,
          sub:  `M ${p.games} ¬∑ SV% ${formatSVP(p.svp)} ¬∑ Nollor ${p.shutouts}`
        };
      }
      if(key === "so" || key === "nollor"){
        return {
          main: `Nollor ${toNum(raw)}`,
          sub:  `M ${p.games} ¬∑ SV% ${formatSVP(p.svp)} ¬∑ GAA ${formatGAA(p.gaa)}`
        };
      }
      return {
        main: `${num}`,
        sub:  `M ${p.games} ¬∑ SV% ${formatSVP(p.svp)} ¬∑ GAA ${formatGAA(p.gaa)}`
      };
    }

    if(key === "p"){
      return { main: `${p.points} po√§ng`, sub: `GP ${p.games} ¬∑ G ${p.goals} ¬∑ A ${p.assists}` };
    }
    if(key === "m"){
      return { main: `${p.goals} m√•l`, sub: `GP ${p.games} ¬∑ P ${p.points} ¬∑ A ${p.assists}` };
    }
    if(key === "a"){
      return { main: `${p.assists} assists`, sub: `GP ${p.games} ¬∑ P ${p.points} ¬∑ G ${p.goals}` };
    }
    if(key === "u"){
      return { main: `${toNum(raw)} utv`, sub: `GP ${p.games} ¬∑ P ${p.points} ¬∑ G ${p.goals} ¬∑ A ${p.assists}` };
    }
    if(key === "ma"){
      return { main: `${toNum(raw)} matcher`, sub: `P ${p.points} ¬∑ G ${p.goals} ¬∑ A ${p.assists}` };
    }
    if(key === "dim"){
      return { main: `DIM ${raw}`, sub: `GP ${p.games} ¬∑ P ${p.points} ¬∑ G ${p.goals} ¬∑ A ${p.assists}` };
    }

    return { main: `${raw}`, sub: `GP ${p.games} ¬∑ P ${p.points} ¬∑ G ${p.goals} ¬∑ A ${p.assists}` };
  }

  function medalForRank(i){
    if(i === 0) return "ü•á";
    if(i === 1) return "ü•à";
    if(i === 2) return "ü•â";
    return "";
  }

  function getStatBarsForSkater(p, players){
    const key = currentSort.key;

    if(key === "u"){
      const maxU = Math.max(...players.map(x => toNum(x.__sortRaw)), 1);
      const maxM = Math.max(...players.map(x => x.games), 1);
      return [
        { label: "Utvisningsmin", value: toNum(p.__sortRaw), percent: (toNum(p.__sortRaw) / maxU) * 100 },
        { label: "Matcher", value: p.games, percent: (p.games / maxM) * 100 }
      ];
    }

    if(key === "ma"){
      const maxM = Math.max(...players.map(x => x.games), 1);
      return [{ label: "Matcher", value: p.games, percent: (p.games / maxM) * 100 }];
    }

    if(key === "dim"){
      const maxDIM = Math.max(...players.map(x => toNum(x.__sortRaw)), 1);
      return [{ label: "DIM", value: p.__sortRaw, percent: (toNum(p.__sortRaw) / maxDIM) * 100 }];
    }

    const maxG = Math.max(...players.map(x => x.goals), 1);
    const maxA = Math.max(...players.map(x => x.assists), 1);
    const maxP = Math.max(...players.map(x => x.points), 1);

    return [
      { label: "M√•l",     value: p.goals,   percent: (p.goals / maxG) * 100 },
      { label: "Assists", value: p.assists, percent: (p.assists / maxA) * 100 },
      { label: "Po√§ng",   value: p.points,  percent: (p.points / maxP) * 100 }
    ];
  }

  function renderTop3Skaters(players, host){
    host.innerHTML = players.slice(0,3).map((p,i)=>{
      const mt = metricTextForPlayer(p);
      const bars = getStatBarsForSkater(p, players);

      return `
        <div class="player-card">
          <div class="player-ribbon"></div>

          ${p.teamLogo ? `
            <div class="team-logo-wrap">
              <img class="team-logo-card" src="${p.teamLogo}" alt="${p.team}">
              <div class="team-medal">${medalForRank(i)}</div>
            </div>
          ` : ""}

          <div class="player-top-row">
            <div class="player-img-wrap">
              <img class="player-img" src="${p.img}" alt="${p.name}"
                   onerror="this.onerror=null;this.src='${DEFAULT_IMG}'">
            </div>
            <div>
              <div class="player-name">${p.name}</div>
              <div class="player-team">${p.team}</div>
              <div class="player-points">${mt.main}</div>
              <div class="player-ga">${mt.sub}</div>
            </div>
          </div>

          <div class="stat-bars">
            ${bars.map(b=>`
              <div class="bar-row">
                <div class="bar-label"><span>${b.label}</span><span>${b.value}</span></div>
                <div class="bar-track"><div class="bar-fill" style="width:${b.percent}%"></div></div>
              </div>
            `).join("")}
          </div>
        </div>
      `;
    }).join("");
  }

  function renderTop3Goalies(players, host){
    const maxM  = Math.max(...players.map(p => p.games), 1);
    const maxSV = Math.max(...players.map(p => p.svpVal), 0.0001);
    const maxSO = Math.max(...players.map(p => p.shutouts), 1);

    host.innerHTML = players.slice(0,3).map((p,i)=>{
      const mt = metricTextForPlayer(p);

      return `
        <div class="player-card">
          <div class="player-ribbon"></div>

          ${p.teamLogo ? `
            <div class="team-logo-wrap">
              <img class="team-logo-card" src="${p.teamLogo}" alt="${p.team}">
              <div class="team-medal">${medalForRank(i)}</div>
            </div>
          ` : ""}

          <div class="player-top-row">
            <div class="player-img-wrap">
              <img class="player-img" src="${p.img}" alt="${p.name}"
                   onerror="this.onerror=null;this.src='${DEFAULT_IMG}'">
            </div>
            <div>
              <div class="player-name">${p.name}</div>
              <div class="player-team">${p.team}</div>
              <div class="player-points">${mt.main}</div>
              <div class="player-ga">${mt.sub}</div>
            </div>
          </div>

          <div class="stat-bars">
            <div class="bar-row">
              <div class="bar-label"><span>Matcher</span><span>${p.games}</span></div>
              <div class="bar-track"><div class="bar-fill" style="width:${(p.games/maxM)*100}%"></div></div>
            </div>
            <div class="bar-row">
              <div class="bar-label"><span>R√§ddnings%</span><span>${formatSVP(p.svp)}</span></div>
              <div class="bar-track"><div class="bar-fill" style="width:${(p.svpVal/maxSV)*100}%"></div></div>
            </div>
            <div class="bar-row">
              <div class="bar-label"><span>Nollor</span><span>${p.shutouts}</span></div>
              <div class="bar-track"><div class="bar-fill" style="width:${(p.shutouts/maxSO)*100}%"></div></div>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderTableGeneric(header, rows, host, searchEl, rowObjects, top3Host, top3Renderer){

    const fullHeader = ["#"].concat(header);
    let data = rows.map((r, i)=>({ rank:i+1, row:r, rowIndex:i }));

    function htmlBody(arr){
      return arr.map((x)=>`
        <tr>
          <td>${x.rank}</td>
          ${x.row.map(c=>`<td>${c ?? ""}</td>`).join("")}
        </tr>
      `).join("");
    }

    host.innerHTML = `
      <table>
        <thead>
          <tr>
            ${fullHeader.map((h, idx)=>`<th data-idx="${idx}">${h}</th>`).join("")}
          </tr>
        </thead>
        <tbody>${htmlBody(data)}</tbody>
      </table>
    `;

    const tbody = host.querySelector("tbody");
    const ths = host.querySelectorAll("thead th");
    let sortState = { idx: null, asc: false };

    // default sort: Po√§ng ‚Üí M√•l ‚Üí Matcher (om det finns)
    data.sort((a,b)=>{
      const pa = rowObjects[a.rowIndex];
      const pb = rowObjects[b.rowIndex];
      if ((pa.points ?? 0) !== (pb.points ?? 0)) return (pb.points ?? 0) - (pa.points ?? 0);
      if ((pa.goals  ?? 0) !== (pb.goals  ?? 0)) return (pb.goals  ?? 0) - (pa.goals  ?? 0);
      if ((pa.games  ?? 0) !== (pb.games  ?? 0)) return (pa.games  ?? 0) - (pb.games  ?? 0);
      return 0;
    });

    data = data.map((x,i)=>({ ...x, rank: i+1 }));
    tbody.innerHTML = htmlBody(data);

    function applySearchAndTop3(){
      const q = (searchEl && searchEl.value ? searchEl.value.toLowerCase() : "");
      const visible = [];

      [...tbody.rows].forEach((tr, i)=>{
        const match = !q || tr.innerText.toLowerCase().includes(q);
        tr.style.display = match ? "" : "none";
        if(match){
          const d = data[i];
          const obj = rowObjects && d ? rowObjects[d.rowIndex] : null;
          if(obj){
            if(sortState.idx && sortState.idx > 0){
              const colIdx = sortState.idx - 1;
              obj.__sortRaw = (d.row[colIdx] ?? "");
              obj.__sortNum = toNum(obj.__sortRaw);
              obj.__sortKey = currentSort.key;
            } else {
              obj.__sortRaw = "";
              obj.__sortNum = 0;
              obj.__sortKey = null;
            }
            visible.push(obj);
          }
        }
      });

      let top3Data = visible;

      if(activeLeague === "defenders" && currentSort.key === "dim"){
        top3Data = visible.filter(p => (p.games ?? 0) > 4);
      }

      if(activeLeague === "goalies"){
        top3Data = visible.filter(p => (p.games ?? 0) > 5);
      }

      if(!sortState.idx){
        top3Data = top3Data.slice().sort((a,b)=>{
          if((a.points ?? 0) !== (b.points ?? 0)) return (b.points ?? 0) - (a.points ?? 0);
          if((a.goals  ?? 0) !== (b.goals  ?? 0)) return (b.goals  ?? 0) - (a.goals  ?? 0);
          return (a.games ?? 0) - (b.games ?? 0);
        });
      }

      if(sortState.idx && sortState.idx > 0){
        top3Data = top3Data.slice().sort((a,b)=>{
          const av = a.__sortNum ?? 0;
          const bv = b.__sortNum ?? 0;

          if(activeLeague === "goalies" && currentSort.key === "gaa"){
            if(av !== bv) return av - bv;
            if((a.games ?? 0) !== (b.games ?? 0)) return (a.games ?? 0) - (b.games ?? 0);
            return 0;
          }

          if(av !== bv) return bv - av;

          if((b.goals ?? 0) !== (a.goals ?? 0)) return (b.goals ?? 0) - (a.goals ?? 0);
          if((a.games ?? 0) !== (b.games ?? 0)) return (a.games ?? 0) - (b.games ?? 0);
          return 0;
        });
      }

      top3Renderer(top3Data, top3Host);
    }

    ths.forEach(th=>{
      th.addEventListener("click", ()=>{
        const idx = Number(th.dataset.idx);
        if(idx === 0) return;

        const colName = header[idx-1] || "";
        const key = resolveSortKey(colName);
        currentSort = { idx: idx, key, label: sortTitles[key] || null };

        setSortedTitleByColumn(colName);

        if(sortState.idx === idx){
          sortState.asc = !sortState.asc;
        } else {
          sortState.idx = idx;
          if(activeLeague === "goalies" && currentSort.key === "gaa"){
            sortState.asc = true;
          } else {
            sortState.asc = false;
          }
        }

        const dir = sortState.asc ? 1 : -1;

        if (currentSort.key === "p") {
          data.sort((a, b) => {
            const pa = rowObjects[a.rowIndex];
            const pb = rowObjects[b.rowIndex];
            if ((pa.points ?? 0) !== (pb.points ?? 0)) return (pb.points ?? 0) - (pa.points ?? 0);
            if ((pa.goals  ?? 0) !== (pb.goals  ?? 0)) return (pb.goals  ?? 0) - (pa.goals  ?? 0);
            if ((pa.games  ?? 0) !== (pb.games  ?? 0)) return (pa.games  ?? 0) - (pb.games  ?? 0);
            return 0;
          });
        } else {
          data.sort((a, b) => {
            const va = (a.row[idx - 1] ?? "").toString();
            const vb = (b.row[idx - 1] ?? "").toString();
            const na = toNum(va), nb = toNum(vb);
            const isNum = !(isNaN(na) || isNaN(nb)) && (va.trim() !== "" || vb.trim() !== "");
            if (isNum) return (na - nb) * dir;
            return va.localeCompare(vb, "sv") * dir;
          });
        }

        data = data.map((x, i) => ({ ...x, rank: i + 1 }));
        tbody.innerHTML = htmlBody(data);
        applySearchAndTop3();
      });
    });

    if(searchEl){
      searchEl.oninput = applySearchAndTop3;
    }

    applySearchAndTop3();
  }

  // TITLAR
  const titleIcon = document.getElementById("titleIcon");
  const titleText = document.getElementById("titleText");
  const titleSub  = document.getElementById("titleSub");
  const sectionTitle = document.getElementById("sectionTitle");
  const tableStrip = document.getElementById("tableStrip");
  const top3 = document.getElementById("top3");
  const tableHost = document.getElementById("tableHost");
  const updated = document.getElementById("updated");
  const searchBox = document.getElementById("searchBox");

  function stageSuffix(){
    return activeStage === "playoffs" ? " ‚Äì Slutspel" : "";
  }

  function setTitles(){
    const divName = divLabels[activeDiv];
    const descEl = document.getElementById("sectionDesc");
    if(descEl) descEl.innerHTML = "";

    currentSort = { idx: null, key: null, label: null };

    titleSub.textContent = stageLabels[activeStage].toUpperCase();

    if(activeLeague === "skaters"){
      titleIcon.textContent = "üèÜ";
      titleText.textContent = "ECL 26 Winter ‚Äì Svenska po√§ngligor" + stageSuffix();
      sectionTitle.textContent = `${divName} Po√§ngliga` + (activeStage === "playoffs" ? " ‚Äì Slutspel" : "");
      tableStrip.textContent = `Topplista ${divName}` + (activeStage === "playoffs" ? " ‚Äì Slutspel" : "");
    } else if(activeLeague === "defenders"){
      titleIcon.textContent = "üèí";
      titleText.textContent = "ECL 26 Winter ‚Äì Svenska backligan" + stageSuffix();
      sectionTitle.textContent = `${divName} Backliga` + (activeStage === "playoffs" ? " ‚Äì Slutspel" : "");
      tableStrip.textContent = `Topplista ${divName}` + (activeStage === "playoffs" ? " ‚Äì Slutspel" : "");
    } else {
      titleIcon.textContent = "ü•Ö";
      titleText.textContent = "ECL 26 Winter ‚Äì Svenska m√•lvaktsligan" + stageSuffix();
      sectionTitle.textContent = `${divName} M√•lvaktsliga` + (activeStage === "playoffs" ? " ‚Äì Slutspel" : "");
      tableStrip.textContent = `Topplista ${divName}` + (activeStage === "playoffs" ? " ‚Äì Slutspel" : "");
    }

    searchBox.value = "";
  }

  function setSortedTitleByColumn(colName){
    const key = resolveSortKey(colName);
    const leagueLabel = sortTitles[key];
    if(!leagueLabel) return;

    const divName = divLabels[activeDiv];
    const descEl = document.getElementById("sectionDesc");
    if(descEl) descEl.innerHTML = "";

    titleSub.textContent = stageLabels[activeStage].toUpperCase();

    if(activeLeague === "skaters"){
      titleIcon.textContent = "üèÜ";
      titleText.textContent = `ECL 26 Winter ‚Äì Svenska ${leagueLabel.toLowerCase()}` + stageSuffix();
      sectionTitle.textContent = `${divName} ${leagueLabel}` + (activeStage === "playoffs" ? " ‚Äì Slutspel" : "");
      return;
    }

    if(activeLeague === "defenders"){
      titleIcon.textContent = "üèí";
      titleText.textContent = `ECL 26 Winter ‚Äì Svenska ${leagueLabel.toLowerCase()}` + stageSuffix();
      sectionTitle.textContent = `${divName} ${leagueLabel}` + (activeStage === "playoffs" ? " ‚Äì Slutspel" : "");

      if(key === "dim" && descEl){
        descEl.innerHTML =
          `Defensiv Impact per match (DIM) √§r ett sammansatt nyckeltal som m√§ter hur mycket en spelare bidrar <br/>` +
          `defensivt per match, oberoende av offensiv produktion. Fokus ligger p√• att stoppa anfall, bryta pucktempo och f√∂rhindra farliga avslut.`;
      }
      return;
    }

    if(activeLeague === "goalies"){
      titleIcon.textContent = "ü•Ö";
      titleText.textContent = `ECL 26 Winter ‚Äì Svenska ${leagueLabel.toLowerCase()}` + stageSuffix();
      sectionTitle.textContent = `${divName} ${leagueLabel}` + (activeStage === "playoffs" ? " ‚Äì Slutspel" : "");
      return;
    }
  }

  function getActiveDataSheets(){
    return activeStage === "playoffs" ? DATA_SHEETS_PLAYOFFS : DATA_SHEETS_REGULAR;
  }

  function load(){
    setTitles();

    tableHost.innerHTML = `<div style="padding:10px;color:#fff;">Laddar statistik‚Ä¶</div>`;
    top3.innerHTML = "";

    const url = getActiveDataSheets()[activeLeague];

    Promise.all([loadCardImages(), loadTeamLogos()]).then(([map, logos])=>{
      fetch(url)
        .then(r=>r.text())
        .then(csv=>{
          const rows = parseCSV(csv);
          if(!rows.length){
            tableHost.innerHTML = `<div style="padding:10px;color:#fff;">Ingen data.</div>`;
            return;
          }

          const header = rows.shift();
          const divIdx = findDivIndex(header);

          const filtered = divIdx >= 0
            ? rows.filter(r => isRowInDivision(r[divIdx], divLabels[activeDiv]))
            : rows;

          if(!filtered.length){
            tableHost.innerHTML = `<div style="padding:10px;color:#fff;">Ingen data f√∂r ${divLabels[activeDiv]}.</div>`;
            return;
          }

          if(activeLeague === "skaters" || activeLeague === "defenders"){
            const hn = header.map(h=>normalize(h));
            const idxName = hn.findIndex(x=>["namn","name","psn"].includes(x));
            const idxTeam = hn.findIndex(x=>["lag","team"].includes(x));
            const idxGP   = hn.findIndex(x=>["gp","matcher","games","ma"].includes(x));
            const idxG    = hn.findIndex(x=>["m","mal","m√•l","goals","g"].includes(x));
            const idxA    = hn.findIndex(x=>["a","assists","assist"].includes(x));
            const idxP    = hn.findIndex(x=>["p","poang","po√§ng","points"].includes(x));

            const players = filtered.map(r=>{
              const name = (r[idxName >= 0 ? idxName : 0] || "").trim();
              const team = (r[idxTeam >= 0 ? idxTeam : 1] || "").trim();
              const games = toNum(r[idxGP >= 0 ? idxGP : 2]);
              const goals = toNum(r[idxG  >= 0 ? idxG  : 3]);
              const assists = toNum(r[idxA >= 0 ? idxA : 4]);
              const points = toNum(r[idxP >= 0 ? idxP : 5]);

              const key = normalize(name);
              const img = map[key] || DEFAULT_IMG;
              const teamLogo = logos[normalize(team)] || "";

              return { name, team, games, goals, assists, points, img, teamLogo };
            }).filter(p=>p.name);

            const cleanHeader = divIdx >= 0 ? header.filter((_,i)=>i!==divIdx) : header;
            const cleanRows   = divIdx >= 0 ? filtered.map(r=>r.filter((_,i)=>i!==divIdx)) : filtered;

            renderTableGeneric(cleanHeader, cleanRows, tableHost, searchBox, players, top3, renderTop3Skaters);

          } else {
            const hn = header.map(h=>normalize(h));
            const idxName = hn.findIndex(x=>["namn","name"].includes(x));
            const idxTeam = hn.findIndex(x=>["lag","team"].includes(x));
            const idxM    = hn.findIndex(x=>["m","ma","matcher","games","gp"].includes(x));
            const idxGAA  = hn.findIndex(x=>["gaa"].includes(x));
            const idxSV   = hn.findIndex(x=>["sv","sv%","svp","svprocent","r√§ddningsprocent","save%","savepercentage"].includes(x));
            const idxSO   = hn.findIndex(x=>["nollor","so","shutouts"].includes(x));

            const goalies = filtered.map(r=>{
              const name = (r[idxName >= 0 ? idxName : 0] || "").trim();
              const team = (r[idxTeam >= 0 ? idxTeam : 1] || "").trim();
              const games = toNum(r[idxM >= 0 ? idxM : 2]);
              const gaa = (r[idxGAA >= 0 ? idxGAA : 3] || "");
              const svp = (r[idxSV >= 0 ? idxSV : 4] || "");
              const shutouts = toNum(r[idxSO >= 0 ? idxSO : 5]);

              const key = normalize(name);
              const img = map[key] || DEFAULT_IMG;
              const teamLogo = logos[normalize(team)] || "";

              return { name, team, games, gaa, svp, svpVal: parseSVP(svp), shutouts, img, teamLogo };
            }).filter(p=>p.name);

            const cleanHeader = divIdx >= 0 ? header.filter((_,i)=>i!==divIdx) : header;
            const cleanRows   = divIdx >= 0 ? filtered.map(r=>r.filter((_,i)=>i!==divIdx)) : filtered;

            renderTableGeneric(cleanHeader, cleanRows, tableHost, searchBox, goalies, top3, renderTop3Goalies);
          }

          updated.textContent = "Senast uppdaterad: " + new Date().toLocaleString("sv-SE");
        })
        .catch(err=>{
          tableHost.innerHTML = `<div style="padding:10px;color:#fff;">Fel vid laddning: ${err.message}</div>`;
        });
    });
  }

  // Klick: Spelform
  document.querySelectorAll(".ecl-tab[data-stage]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".ecl-tab[data-stage]").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      activeStage = btn.dataset.stage;
      load();
    });
  });

  // Klick: League
  document.querySelectorAll(".ecl-tab[data-league]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".ecl-tab[data-league]").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      activeLeague = btn.dataset.league;
      load();
    });
  });

  // Klick: Division
  document.querySelectorAll(".ecl-tab[data-division]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".ecl-tab[data-division]").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      activeDiv = btn.dataset.division;
      load();
    });
  });

  load();

})();
</script>

</body>
</html>
